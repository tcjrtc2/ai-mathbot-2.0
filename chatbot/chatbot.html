<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Tutor - Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Theme Variables */
        :root {
            /* Light Theme Colors - Enhanced */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --bg-chat: #ffffff;
            --bg-header: rgba(248, 250, 252, 0.95);
            --bg-modal: rgba(255, 255, 255, 0.98);
            --bg-gradient-start: #f8fafc;
            --bg-gradient-middle: #e2e8f0;
            --bg-gradient-end: #cbd5e1;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-inverse: #ffffff;
            
            --border-primary: rgba(34, 197, 94, 0.4);
            --border-secondary: rgba(148, 163, 184, 0.6);
            --border-muted: rgba(203, 213, 225, 0.8);
            
            --shadow-color: rgba(0, 0, 0, 0.15);
            --shadow-emerald: rgba(34, 197, 94, 0.25);
            --shadow-amber: rgba(245, 158, 11, 0.35);
            
            --scrollbar-track: rgba(203, 213, 225, 0.4);
            --scrollbar-thumb: rgba(34, 197, 94, 0.4);
            --scrollbar-thumb-hover: rgba(34, 197, 94, 0.6);
            
            --geometric-border: rgba(34, 197, 94, 0.2);
            --geometric-bg: rgba(34, 197, 94, 0.1);
        }
        
        [data-theme="dark"] {
            /* Dark Theme Colors - Refined */
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2e;
            --bg-tertiary: #1f2937;
            --bg-chat: #151b2e;
            --bg-header: rgba(21, 27, 46, 0.85);
            --bg-modal: rgba(21, 27, 46, 0.98);
            --bg-gradient-start: #0a0e1a;
            --bg-gradient-middle: #151b2e;
            --bg-gradient-end: #1f2937;
            
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-inverse: #0f172a;
            
            --border-primary: rgba(34, 197, 94, 0.4);
            --border-secondary: rgba(71, 85, 105, 0.6);
            --border-muted: rgba(51, 65, 85, 0.8);
            
            --shadow-color: rgba(0, 0, 0, 0.5);
            --shadow-emerald: rgba(34, 197, 94, 0.3);
            --shadow-amber: rgba(245, 158, 11, 0.4);
            
            --scrollbar-track: rgba(31, 41, 55, 0.5);
            --scrollbar-thumb: rgba(34, 197, 94, 0.4);
            --scrollbar-thumb-hover: rgba(34, 197, 94, 0.6);
            
            --geometric-border: rgba(34, 197, 94, 0.2);
            --geometric-bg: rgba(34, 197, 94, 0.06);
        }

        /* Custom gradient for radial background */
        .bg-gradient-radial {
            background: radial-gradient(circle at center, var(--tw-gradient-stops));
        }

        /* Theme-aware background classes */
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background-color: var(--bg-secondary); }
        .bg-theme-tertiary { background-color: var(--bg-tertiary); }
        .bg-theme-chat { background-color: var(--bg-chat); }
        .bg-theme-header { background-color: var(--bg-header); }
        .bg-theme-modal { background-color: var(--bg-modal); }
        
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .text-theme-muted { color: var(--text-muted); }
        .text-theme-inverse { color: var(--text-inverse); }
        
        .border-theme-primary { border-color: var(--border-primary); }
        .border-theme-secondary { border-color: var(--border-secondary); }
        .border-theme-muted { border-color: var(--border-muted); }

        /* 3D Transform utilities */
        .transform-3d {
            transform-style: preserve-3d;
        }

        /* Enhanced animations with green theme */
        @keyframes float-3d {
            0%, 100% {
                transform: translateY(0px) rotateZ(0deg);
            }
            50% {
                transform: translateY(-20px) rotateZ(2deg);
            }
        }

        .animate-float-3d {
            animation: float-3d 6s ease-in-out infinite;
        }

        @keyframes pulse-glow-green {
            0%, 100% {
                box-shadow: 0 0 20px var(--shadow-emerald);
            }
            50% {
                box-shadow: 0 0 30px var(--shadow-emerald);
            }
        }

        @keyframes pulse-glow-gold {
            0%, 100% {
                box-shadow: 0 0 20px var(--shadow-amber);
            }
            50% {
                box-shadow: 0 0 30px var(--shadow-amber);
            }
        }

        /* Dark mode specific enhancements */
        [data-theme="dark"] .geometric-glow {
            filter: drop-shadow(0 0 10px rgba(34, 197, 94, 0.3));
        }
        
        [data-theme="light"] .geometric-glow {
            filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.2));
        }

        /* Theme button breathing animation */
        @keyframes theme-button-breathe {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        #themeToggleBtn:hover {
            animation: theme-button-breathe 2s ease-in-out infinite;
        }

        /* Enhanced backdrop blur for dark mode */
        [data-theme="dark"] .backdrop-blur-xl {
            backdrop-filter: blur(20px) saturate(1.5);
        }
        
        [data-theme="light"] .backdrop-blur-xl {
            backdrop-filter: blur(16px) saturate(1.2);
        }

        /* Responsive Design - Mobile First */
        
        /* Base styles for mobile (320px+) */
        .responsive-container {
            padding: 1rem;
        }
        
        .responsive-header {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }
        
        .responsive-buttons {
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .responsive-input {
            padding: 0.75rem;
        }
        
        .responsive-geometric {
            display: none; /* Hide complex animations on mobile */
        }

        /* Small Mobile (480px+) */
        @media (min-width: 480px) {
            .responsive-container {
                padding: 1.5rem;
            }
            
            .responsive-header {
                flex-direction: row;
                padding: 1.5rem;
            }
            
            .responsive-buttons {
                gap: 0.75rem;
                justify-content: flex-start;
            }
            
            .responsive-geometric {
                display: block;
                opacity: 0.3;
            }
        }

        /* Tablet Portrait (768px+) */
        @media (min-width: 768px) {
            .responsive-container {
                padding: 2rem;
            }
            
            .responsive-header {
                padding: 1.5rem 2rem;
            }
            
            .responsive-input {
                padding: 1rem;
            }
            
            .responsive-geometric {
                opacity: 0.6;
            }
        }

        /* Tablet Landscape / Small Desktop (1024px+) */
        @media (min-width: 1024px) {
            .responsive-container {
                padding: 2rem;
                max-width: none;
            }
            
            .responsive-header {
                padding: 1.5rem 2rem;
            }
            
            .responsive-geometric {
                opacity: 1;
            }
        }

        /* Large Desktop (1440px+) */
        @media (min-width: 1440px) {
            .responsive-container {
                padding: 2rem;
            }
        }

        /* Ultra Wide (1920px+) */
        @media (min-width: 1920px) {
            .responsive-container {
                max-width: 1800px;
                margin: 0 auto;
            }
        }

        /* Mobile-specific utilities */
        @media (max-width: 767px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-px-4 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            .mobile-py-2 {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            button, input, select, textarea {
                min-height: 44px; /* Apple's recommended touch target size */
            }
            
            .hover\:scale-105:hover {
                transform: none; /* Disable hover animations on touch devices */
            }
        }

        .animate-pulse-glow-green {
            animation: pulse-glow-green 2s ease-in-out infinite;
        }

        .animate-pulse-glow-gold {
            animation: pulse-glow-gold 2s ease-in-out infinite;
        }

        /* Chat specific animations */
        @keyframes typing-dot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .typing-dot:nth-child(1) {
            animation: typing-dot 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation: typing-dot 1.4s infinite 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation: typing-dot 1.4s infinite 0.4s;
        }

        @keyframes slide-in {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slide-in 0.3s ease-out;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Message fade in */
        .message-fade-in {
            animation: messageSlideIn 0.5s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen relative overflow-hidden bg-theme-primary transition-colors duration-300" data-theme="light">
    <!-- Professional 3D Background -->
    <div class="absolute inset-0 overflow-hidden">
        <!-- Sophisticated Gradient Background -->
        <div class="absolute inset-0" style="background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-middle) 50%, var(--bg-gradient-end) 100%);"></div>

        <!-- Refined 3D Geometric Elements - Responsive -->
        <div class="responsive-geometric absolute top-16 left-4 sm:top-32 sm:left-24 w-16 h-16 sm:w-24 sm:h-24 rotate-45 animate-pulse geometric-glow transition-all duration-500" style="border: 1px solid var(--geometric-border);"></div>
        <div class="responsive-geometric absolute top-32 right-4 sm:top-48 sm:right-32 w-20 h-20 sm:w-32 sm:h-32 rotate-12 animate-pulse geometric-glow transition-all duration-500" style="border: 1px solid var(--geometric-border); animation-delay: 1s;"></div>
        <div class="responsive-geometric absolute bottom-32 left-8 sm:bottom-40 sm:left-48 w-12 h-12 sm:w-16 sm:h-16 rotate-45 geometric-glow transition-all duration-500" style="background: linear-gradient(45deg, var(--geometric-bg), transparent);"></div>
        <div class="responsive-geometric absolute bottom-48 right-4 sm:bottom-72 sm:right-24 w-24 h-24 sm:w-36 sm:h-36 rounded-full geometric-glow transition-all duration-500" style="border: 1px solid var(--geometric-border);"></div>
        
        <!-- Additional geometric elements for dark mode depth -->
        <div class="responsive-geometric absolute top-1/3 left-1/4 w-6 h-6 sm:w-8 sm:h-8 rotate-45 animate-pulse geometric-glow transition-all duration-500" style="background: linear-gradient(135deg, var(--geometric-bg), transparent); animation-delay: 2s;"></div>
        <div class="responsive-geometric absolute bottom-1/3 right-1/3 w-8 h-8 sm:w-12 sm:h-12 rounded-full animate-pulse geometric-glow transition-all duration-500" style="border: 1px solid var(--geometric-border); animation-delay: 1.5s;"></div>

        <!-- Subtle Radial Overlay -->
        <div class="absolute inset-0" style="background: radial-gradient(circle at center, transparent 0%, var(--bg-gradient-middle) 60%, var(--bg-gradient-end) 100%);"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 flex flex-col h-screen responsive-container">
        <!-- Professional Header -->
        <header class="responsive-header flex items-center justify-between backdrop-blur-xl border-b flex-shrink-0 transition-colors duration-300" style="background-color: var(--bg-header); border-color: var(--border-primary);">
            <div class="flex items-center gap-2 sm:gap-4">
                <div class="relative w-10 h-10 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl border flex items-center justify-center shadow-lg sm:shadow-xl transition-colors duration-300" style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border-color: var(--border-primary); box-shadow: 0 4px 15px var(--shadow-emerald);">
                    <div class="w-6 h-6 sm:w-10 sm:h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg sm:rounded-xl flex items-center justify-center">
                        <!-- Brain Icon SVG -->
                        <svg class="w-3 h-3 sm:w-6 sm:h-6 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="absolute inset-0 bg-emerald-400/15 rounded-xl sm:rounded-2xl blur-sm"></div>
                </div>
                <div class="mobile-text-center">
                    <h1 class="text-lg sm:text-2xl tracking-tight font-medium text-theme-primary transition-colors duration-300">AI Math Tutor Chat</h1>
                    <p class="text-xs sm:text-sm text-theme-muted transition-colors duration-300 mobile-hidden">Interactive Learning Assistant</p>
                </div>
            </div>
            
            <div class="responsive-buttons flex items-center gap-1 sm:gap-3">
                <!-- Theme Toggle Button -->
                <button id="themeToggleBtn" class="inline-flex items-center justify-center rounded-lg sm:rounded-xl px-2 sm:px-4 py-1 sm:py-2 text-xs sm:text-sm font-medium transition-all duration-300 backdrop-blur-xl border hover:scale-105 relative" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" title="Toggle Theme">
                    <!-- Icon Container -->
                    <div class="relative w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2">
                        <!-- Sun Icon (for light mode) -->
                        <svg id="sunIcon" class="absolute inset-0 w-3 h-3 sm:w-4 sm:h-4 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <!-- Moon Icon (for dark mode) -->
                        <svg id="moonIcon" class="absolute inset-0 w-3 h-3 sm:w-4 sm:h-4 transition-all duration-300 opacity-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </div>
                    <span id="themeText" class="mobile-hidden">Dark Mode</span>
                </button>
                
                <button id="apiSettingsBtn" class="inline-flex items-center justify-center rounded-lg sm:rounded-xl px-2 sm:px-4 py-1 sm:py-2 text-xs sm:text-sm font-medium transition-all duration-300 backdrop-blur-xl border hover:scale-105" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" title="API Settings">
                    <!-- Key Icon -->
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-0 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m-2-2l-2.5-2.5a2 2 0 00-2.828 0L5.5 8.5a2 2 0 000 2.828L7 12.828m8-5.828l2.5 2.5a2 2 0 010 2.828L15 14.828M12 12l-4 4m0 0l-1.5 1.5M8 16l4-4"></path>
                    </svg>
                    <span class="mobile-hidden">API Key</span>
                </button>
                <button id="clearChatBtn" class="inline-flex items-center justify-center rounded-lg sm:rounded-xl px-2 sm:px-4 py-1 sm:py-2 text-xs sm:text-sm font-medium transition-all duration-300 backdrop-blur-xl border hover:scale-105" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);">
                    <!-- Refresh Icon -->
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-0 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span class="mobile-hidden">Clear Chat</span>
                </button>
                <div class="w-8 h-8 sm:w-12 sm:h-12 border rounded-full flex items-center justify-center transition-colors duration-300" style="border-color: var(--border-primary); background-color: var(--bg-secondary);">
                    <!-- User Icon SVG -->
                    <svg class="w-4 h-4 sm:w-6 sm:h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
            <div class="relative max-w-sm sm:max-w-md w-full p-4 sm:p-6 backdrop-blur-xl border rounded-xl sm:rounded-2xl shadow-2xl transition-colors duration-300" style="background-color: var(--bg-modal); border-color: var(--border-primary); box-shadow: 0 25px 50px var(--shadow-emerald);">
                <div class="absolute inset-0 rounded-xl sm:rounded-2xl" style="background: linear-gradient(135deg, var(--geometric-bg), transparent);"></div>
                <div class="relative">
                    <div class="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg sm:rounded-xl flex items-center justify-center">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m-2-2l-2.5-2.5a2 2 0 00-2.828 0L5.5 8.5a2 2 0 000 2.828L7 12.828m8-5.828l2.5 2.5a2 2 0 010 2.828L15 14.828M12 12l-4 4m0 0l-1.5 1.5M8 16l4-4"></path>
                            </svg>
                        </div>
                        <h2 class="text-lg sm:text-xl font-semibold text-theme-primary transition-colors duration-300">API Configuration</h2>
                    </div>
                    
                    <p class="text-theme-secondary mb-3 sm:mb-4 text-xs sm:text-sm leading-relaxed transition-colors duration-300">
                        To provide intelligent math tutoring, please enter your OpenAI API key. This key will be stored locally in your browser and used to generate responses.
                    </p>
                    
                    <div class="space-y-3 sm:space-y-4">
                        <div>
                            <label for="apiKeyInput" class="block text-xs sm:text-sm font-medium text-theme-secondary mb-2 transition-colors duration-300">
                                OpenAI API Key
                            </label>
                            <input 
                                type="password" 
                                id="apiKeyInput" 
                                placeholder="sk-..." 
                                class="w-full h-10 sm:h-12 border rounded-lg sm:rounded-xl px-3 sm:px-4 outline-none focus:ring-1 transition-all duration-300 text-sm sm:text-base"
                                style="background-color: var(--bg-tertiary); border-color: var(--border-primary); color: var(--text-primary);"
                            />
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="rememberKey" class="w-3 h-3 sm:w-4 sm:h-4 text-emerald-600 rounded focus:ring-emerald-500" style="background-color: var(--bg-tertiary); border-color: var(--border-secondary);">
                            <label for="rememberKey" class="text-xs sm:text-sm text-theme-muted transition-colors duration-300">Remember this key (stored locally)</label>
                        </div>
                        
                        <div class="mobile-stack flex gap-2 sm:gap-3 pt-2">
                            <button 
                                id="saveApiKey" 
                                class="mobile-full-width flex-1 h-10 sm:h-11 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg sm:rounded-xl font-medium hover:from-emerald-400 hover:to-emerald-500 transition-all shadow-lg shadow-emerald-500/25 text-sm sm:text-base"
                            >
                                Save & Continue
                            </button>
                            <button 
                                id="skipApiKey" 
                                class="mobile-full-width px-3 sm:px-4 h-10 sm:h-11 border rounded-lg sm:rounded-xl transition-all duration-300 text-sm sm:text-base"
                                style="background-color: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--border-secondary);"
                            >
                                Skip
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg">
                        <p class="text-xs text-amber-200 leading-relaxed">
                            <strong>Privacy Notice:</strong> Your API key is stored locally in your browser and never sent to our servers. It's only used to communicate directly with OpenAI's API.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages Container -->
        <div id="chatContainer" class="flex-1 overflow-y-auto mobile-px-4 px-3 sm:px-6 mobile-py-2 py-2 sm:py-4 space-y-3 sm:space-y-6 custom-scrollbar">
            <!-- Messages will be dynamically inserted here -->
        </div>

        <!-- Chat Input Section -->
        <div class="flex-shrink-0 responsive-input backdrop-blur-xl border-t transition-colors duration-300" style="background-color: var(--bg-header); border-color: var(--border-primary);">
            <div class="mobile-stack flex gap-2 sm:gap-3">
                <div class="relative flex-1 mobile-full-width">
                    <input 
                        id="chatInput"
                        type="text" 
                        placeholder="Ask me anything about mathematics..."
                        class="h-10 sm:h-12 w-full backdrop-blur-xl border focus:ring-1 rounded-lg sm:rounded-xl pr-12 sm:pr-20 px-3 sm:px-4 outline-none transition-all duration-300 text-sm sm:text-base"
                        style="background-color: var(--bg-secondary); border-color: var(--border-primary); color: var(--text-primary);"
                    />
                    <div class="absolute inset-0 rounded-lg sm:rounded-xl pointer-events-none" style="background: linear-gradient(45deg, var(--geometric-bg), transparent);"></div>

                    <!-- Voice input button -->
                    <button id="voiceBtn" class="absolute right-2 sm:right-4 top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-6 h-6 sm:w-8 sm:h-8 p-0 text-amber-400 hover:text-amber-300 hover:bg-amber-500/10 rounded-md sm:rounded-lg border border-amber-500/20 hover:border-amber-400/40 transition-colors flex items-center justify-center">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>
                </div>

                <!-- File upload button -->
                <button id="uploadBtn" class="h-10 sm:h-12 px-2 sm:px-4 text-amber-300 border backdrop-blur-xl rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 mobile-hidden" style="background-color: var(--bg-secondary); border-color: var(--border-secondary);">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-0 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="mobile-hidden">Upload</span>
                </button>

                <!-- Send button -->
                <button id="sendBtn" class="h-10 sm:h-12 px-4 sm:px-8 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/25 border border-emerald-400/30 hover:from-emerald-400 hover:to-emerald-500 rounded-lg sm:rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 text-sm sm:text-base">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-0 sm:mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <span class="mobile-hidden">Send</span>
                </button>
            </div>

            <!-- Quick actions and controls -->
            <div class="mobile-stack flex items-center justify-between mt-2 sm:mt-4">
                <div class="responsive-buttons flex gap-1 sm:gap-2 flex-wrap">
                    <button class="quick-action-btn rounded-md sm:rounded-lg px-2 sm:px-3 py-1 text-xs sm:text-sm transition-all duration-300 hover:scale-105" style="color: var(--text-muted); background-color: var(--bg-secondary); border: 1px solid var(--border-secondary);" data-topic="algebra">
                        <svg class="w-2 h-2 sm:w-3 sm:h-3 mr-1 inline mobile-hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        Algebra
                    </button>
                    <button class="quick-action-btn rounded-md sm:rounded-lg px-2 sm:px-3 py-1 text-xs sm:text-sm transition-all duration-300 hover:scale-105" style="color: var(--text-muted); background-color: var(--bg-secondary); border: 1px solid var(--border-secondary);" data-topic="calculus">
                        <svg class="w-2 h-2 sm:w-3 sm:h-3 mr-1 inline mobile-hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Calculus
                    </button>
                    <button class="quick-action-btn rounded-md sm:rounded-lg px-2 sm:px-3 py-1 text-xs sm:text-sm transition-all duration-300 hover:scale-105" style="color: var(--text-muted); background-color: var(--bg-secondary); border: 1px solid var(--border-secondary);" data-topic="geometry">
                        <svg class="w-2 h-2 sm:w-3 sm:h-3 mr-1 inline mobile-hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        Geometry
                    </button>
                </div>
                
                
                </div>
            </div>
        </div>
    </div>

    <!-- Professional accent elements -->
    <div class="absolute top-0 left-0 w-1 h-24 bg-gradient-to-b from-emerald-500/40 to-transparent animate-pulse"></div>
    <div class="absolute bottom-0 right-0 w-24 h-1 bg-gradient-to-l from-amber-500/40 to-transparent animate-pulse" style="animation-delay: 0.5s;"></div>
    <div class="absolute top-1/4 right-0 w-1 h-16 bg-gradient-to-b from-amber-500/30 to-transparent animate-pulse" style="animation-delay: 1s;"></div>

    <script>
        // Chat functionality
        class MathTutorChat {
            constructor() {
                this.messages = [];
                this.conversationHistory = [];
                this.userProfile = {
                    learningStyle: 'balanced', // visual, analytical, step-by-step, balanced
                    difficultyLevel: 'adaptive', // beginner, intermediate, advanced, adaptive
                    preferredTopics: [],
                    commonMistakes: [],
                    successfulMethods: [],
                    responsePreferences: {
                        detailLevel: 'medium', // brief, medium, detailed
                        examplesPreferred: true,
                        visualAids: true,
                        stepByStep: true
                    }
                };
                this.contextMemory = {
                    currentTopic: null,
                    recentProblems: [],
                    sessionFocus: null,
                    userStrengths: [],
                    userWeaknesses: []
                };
                this.learningAnalytics = {
                    topicFrequency: {},
                    successRate: {},
                    timeSpentPerTopic: {},
                    preferredExplanationTypes: {}
                };
                this.isTyping = false;
                this.isRecording = false;
                this.recognition = null;
                this.apiKey = null;
                this.chatContainer = document.getElementById('chatContainer');
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.clearChatBtn = document.getElementById('clearChatBtn');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.apiSettingsBtn = document.getElementById('apiSettingsBtn');
                this.apiKeyModal = document.getElementById('apiKeyModal');
                
                this.initializeEventListeners();
                this.initializeSpeechRecognition();
                this.loadUserProfile();
                this.initializeTheme();
                this.checkApiKey();
            }

            initializeEventListeners() {
                // Send message on button click
                this.sendBtn.addEventListener('click', () => this.handleSendMessage());
                
                // Send message on Enter key
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSendMessage();
                    }
                });

                // Clear chat
                this.clearChatBtn.addEventListener('click', () => this.clearChat());

                // Voice recording
                this.voiceBtn.addEventListener('click', () => this.toggleVoiceRecording());

                // File upload
                this.uploadBtn.addEventListener('click', () => this.handleFileUpload());

                // API Settings
                this.apiSettingsBtn.addEventListener('click', () => this.showApiKeyModal());

                // Theme Toggle
                document.getElementById('themeToggleBtn').addEventListener('click', () => this.toggleTheme());

                // API Key Modal handlers
                document.getElementById('saveApiKey').addEventListener('click', () => this.saveApiKey());
                document.getElementById('skipApiKey').addEventListener('click', () => this.skipApiKey());
                document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.saveApiKey();
                    }
                });

                // Sample problem buttons
                document.querySelectorAll('.sample-problem-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const problem = e.currentTarget.dataset.problem;
                        this.handleSendMessage(problem);
                    });
                });

                // Quick action buttons
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const topic = e.currentTarget.dataset.topic;
                        this.handleSendMessage(`Help me with ${topic}`);
                    });
                });
            }

            setInitialTime() {
                document.getElementById('initialTime').textContent = new Date().toLocaleTimeString();
            }

            // API Key Management Methods
            checkApiKey() {
                const savedKey = localStorage.getItem('openai_api_key');
                if (savedKey) {
                    this.apiKey = savedKey;
                    this.updateApiKeyStatus();
                    this.hideApiKeyModal();
                    this.setInitialTime();
                    this.initializeChat();
                } else {
                    this.showApiKeyModal();
                }
            }

            showApiKeyModal() {
                this.apiKeyModal.style.display = 'flex';
                document.getElementById('apiKeyInput').focus();
                
                // Pre-fill if key exists
                if (this.apiKey) {
                    document.getElementById('apiKeyInput').value = this.apiKey;
                    document.getElementById('rememberKey').checked = true;
                }
            }

            hideApiKeyModal() {
                this.apiKeyModal.style.display = 'none';
            }

            saveApiKey() {
                const keyInput = document.getElementById('apiKeyInput');
                const rememberKey = document.getElementById('rememberKey').checked;
                const apiKey = keyInput.value.trim();

                if (!apiKey) {
                    this.showToast('❌ Please enter an API key');
                    return;
                }

                if (!apiKey.startsWith('sk-')) {
                    this.showToast('❌ Invalid API key format. Should start with "sk-"');
                    return;
                }

                this.apiKey = apiKey;
                
                if (rememberKey) {
                    localStorage.setItem('openai_api_key', apiKey);
                    this.showToast('✅ API key saved locally');
                } else {
                    localStorage.removeItem('openai_api_key');
                    this.showToast('✅ API key set for this session');
                }

                this.updateApiKeyStatus();
                this.hideApiKeyModal();
                
                // Initialize chat if this is the first time
                if (this.chatContainer.children.length === 0) {
                    this.setInitialTime();
                    this.initializeChat();
                }
            }

            skipApiKey() {
                this.hideApiKeyModal();
                this.showToast('⚠️ Using demo mode - responses will be simulated');
                this.setInitialTime();
                this.initializeChat();
            }

            updateApiKeyStatus() {
                const hasKey = !!this.apiKey;
                this.apiSettingsBtn.style.opacity = hasKey ? '1' : '0.7';
                
                if (hasKey) {
                    this.apiSettingsBtn.title = 'API Key configured - Click to change';
                } else {
                    this.apiSettingsBtn.title = 'Click to configure API Key';
                }
            }

            // Theme Management Methods
            toggleTheme() {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme-preference', newTheme);
                
                this.updateThemeUI(newTheme);
            }

            updateThemeUI(theme) {
                const sunIcon = document.getElementById('sunIcon');
                const moonIcon = document.getElementById('moonIcon');
                const themeText = document.getElementById('themeText');
                
                if (theme === 'dark') {
                    // Transitioning to dark mode - show moon icon
                    sunIcon.style.opacity = '0';
                    sunIcon.style.transform = 'rotate(-90deg) scale(0.8)';
                    moonIcon.style.opacity = '1';
                    moonIcon.style.transform = 'rotate(0deg) scale(1)';
                    themeText.textContent = 'Dark Mode';
                } else {
                    // Transitioning to light mode - show sun icon
                    sunIcon.style.opacity = '1';
                    sunIcon.style.transform = 'rotate(0deg) scale(1)';
                    moonIcon.style.opacity = '0';
                    moonIcon.style.transform = 'rotate(90deg) scale(0.8)';
                    themeText.textContent = 'Light Mode';
                }
                
                // Add subtle glow effect for dark mode
                const button = document.getElementById('themeToggleBtn');
                if (theme === 'dark') {
                    button.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.15)';
                } else {
                    button.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                }
            }

            initializeTheme() {
                const savedTheme = localStorage.getItem('theme-preference');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');
                
                document.body.setAttribute('data-theme', theme);
                this.updateThemeUI(theme);
            }

            initializeChat() {
                // Add initial AI message
                const welcomeMessage = this.apiKey ? 
                    'Welcome! I\'m your AI mathematics tutor powered by OpenAI. I can help you solve problems step by step, explain concepts, and answer any math questions you have. What would you like to work on today?' :
                    'Welcome! I\'m your AI mathematics tutor (Demo Mode). I can help with basic math problems using pre-programmed responses. For advanced AI-powered tutoring, please configure your OpenAI API key. What would you like to work on today?';
                
                this.addMessage('ai', welcomeMessage);
                
                // Show sample problems
                this.showSampleProblems();
            }

            showSampleProblems() {
                const sampleProblemsHtml = `
                    <div id="sampleProblems" class="space-y-3 sm:space-y-4">
                        <h3 class="text-xs sm:text-sm font-medium transition-colors duration-300" style="color: var(--text-muted);">Try these sample problems:</h3>
                        <div class="grid gap-2 sm:gap-3">
                            <button class="sample-problem-btn justify-start h-auto p-3 sm:p-4 border rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 text-left" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" data-problem="Solve for x: 2x + 5 = 15">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-400 rounded-full flex-shrink-0"></div>
                                    <span class="text-xs sm:text-sm">Solve for x: 2x + 5 = 15</span>
                                </div>
                            </button>
                            <button class="sample-problem-btn justify-start h-auto p-3 sm:p-4 border rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 text-left" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" data-problem="Find the derivative of f(x) = x² + 3x - 2">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-400 rounded-full flex-shrink-0"></div>
                                    <span class="text-xs sm:text-sm">Find the derivative of f(x) = x² + 3x - 2</span>
                                </div>
                            </button>
                            <button class="sample-problem-btn justify-start h-auto p-3 sm:p-4 border rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 text-left" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" data-problem="What is the area of a circle with radius 5?">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-400 rounded-full flex-shrink-0"></div>
                                    <span class="text-xs sm:text-sm">What is the area of a circle with radius 5?</span>
                                </div>
                            </button>
                            <button class="sample-problem-btn justify-start h-auto p-3 sm:p-4 border rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 text-left" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" data-problem="Explain the quadratic formula">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-400 rounded-full flex-shrink-0"></div>
                                    <span class="text-xs sm:text-sm">Explain the quadratic formula</span>
                                </div>
                            </button>
                            <button class="sample-problem-btn justify-start h-auto p-3 sm:p-4 border rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 text-left" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-secondary);" data-problem="How do I factor x² - 9?">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-400 rounded-full flex-shrink-0"></div>
                                    <span class="text-xs sm:text-sm">How do I factor x² - 9?</span>
                                </div>
                            </button>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sampleProblemsHtml;
                this.chatContainer.appendChild(tempDiv.firstElementChild);
                
                // Re-attach event listeners for sample problem buttons
                document.querySelectorAll('.sample-problem-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const problem = e.currentTarget.dataset.problem;
                        this.handleSendMessage(problem);
                    });
                });
            }

            // Machine Learning & Adaptive Intelligence Methods
            loadUserProfile() {
                const savedProfile = localStorage.getItem('math_tutor_profile');
                const savedAnalytics = localStorage.getItem('math_tutor_analytics');
                const savedContext = localStorage.getItem('math_tutor_context');
                
                if (savedProfile) {
                    this.userProfile = { ...this.userProfile, ...JSON.parse(savedProfile) };
                }
                if (savedAnalytics) {
                    this.learningAnalytics = { ...this.learningAnalytics, ...JSON.parse(savedAnalytics) };
                }
                if (savedContext) {
                    this.contextMemory = { ...this.contextMemory, ...JSON.parse(savedContext) };
                }
            }

            saveUserProfile() {
                localStorage.setItem('math_tutor_profile', JSON.stringify(this.userProfile));
                localStorage.setItem('math_tutor_analytics', JSON.stringify(this.learningAnalytics));
                localStorage.setItem('math_tutor_context', JSON.stringify(this.contextMemory));
            }

            analyzeUserInput(userMessage) {
                // Enhanced analysis with deeper AI thinking
                const topics = this.extractMathTopics(userMessage);
                const difficulty = this.assessDifficultyLevel(userMessage);
                const questionType = this.classifyQuestionType(userMessage);
                const complexity = this.assessComplexity(userMessage);
                const learningIntent = this.identifyLearningIntent(userMessage);
                const emotionalCues = this.detectEmotionalCues(userMessage);
                const prerequisiteCheck = this.checkPrerequisites(topics);
                
                // Advanced pattern recognition
                const patterns = this.identifyMathPatterns(userMessage);
                const problemSolvingApproach = this.determineSolvingApproach(questionType, difficulty, topics);
                
                // Update learning analytics with enhanced data
                topics.forEach(topic => {
                    this.learningAnalytics.topicFrequency[topic] = 
                        (this.learningAnalytics.topicFrequency[topic] || 0) + 1;
                    
                    // Track complexity progression
                    if (!this.learningAnalytics.complexityProgression) {
                        this.learningAnalytics.complexityProgression = {};
                    }
                    if (!this.learningAnalytics.complexityProgression[topic]) {
                        this.learningAnalytics.complexityProgression[topic] = [];
                    }
                    this.learningAnalytics.complexityProgression[topic].push({
                        complexity: complexity,
                        timestamp: new Date().toISOString()
                    });
                });
                
                // Enhanced context memory with deeper insights
                this.contextMemory.currentTopic = topics[0] || this.contextMemory.currentTopic;
                this.contextMemory.recentProblems.push({
                    message: userMessage,
                    topics: topics,
                    difficulty: difficulty,
                    complexity: complexity,
                    type: questionType,
                    learningIntent: learningIntent,
                    emotionalState: emotionalCues,
                    patterns: patterns,
                    solvingApproach: problemSolvingApproach,
                    prerequisitesMet: prerequisiteCheck,
                    timestamp: new Date().toISOString()
                });
                
                // Adapt learning path based on analysis
                this.adaptLearningPath(topics, difficulty, complexity, learningIntent);
                
                // Keep only recent 15 problems (increased for better pattern recognition)
                if (this.contextMemory.recentProblems.length > 15) {
                    this.contextMemory.recentProblems.shift();
                }
                
                return { 
                    topics, 
                    difficulty, 
                    questionType, 
                    complexity, 
                    learningIntent, 
                    emotionalCues, 
                    patterns, 
                    problemSolvingApproach,
                    prerequisiteCheck
                };
            }

            extractMathTopics(message) {
                const topicKeywords = {
                    'algebra': ['solve', 'equation', 'variable', 'x =', 'linear', 'quadratic', 'polynomial', 'factor', 'expand', 'simplify'],
                    'calculus': ['derivative', 'integral', 'limit', 'differential', 'dx', 'dy', 'chain rule', 'product rule', 'quotient rule'],
                    'geometry': ['area', 'perimeter', 'volume', 'triangle', 'circle', 'polygon', 'angle', 'theorem', 'proof', 'congruent'],
                    'trigonometry': ['sin', 'cos', 'tan', 'sine', 'cosine', 'tangent', 'radian', 'degree', 'identity', 'unit circle'],
                    'statistics': ['mean', 'median', 'mode', 'probability', 'distribution', 'variance', 'standard deviation', 'correlation'],
                    'precalculus': ['function', 'domain', 'range', 'logarithm', 'exponential', 'inverse', 'composition', 'transformation'],
                    'arithmetic': ['add', 'subtract', 'multiply', 'divide', 'fraction', 'decimal', 'percentage', 'ratio'],
                    'linear_algebra': ['matrix', 'vector', 'eigenvalue', 'determinant', 'linear transformation', 'system'],
                    'discrete_math': ['sequence', 'series', 'combinatorics', 'permutation', 'graph theory', 'logic'],
                    'number_theory': ['prime', 'divisible', 'modular', 'greatest common divisor', 'least common multiple']
                };
                
                const foundTopics = [];
                const lowerMessage = message.toLowerCase();
                
                // Enhanced topic detection with weighted scoring
                const topicScores = {};
                
                for (const [topic, keywords] of Object.entries(topicKeywords)) {
                    let score = 0;
                    keywords.forEach(keyword => {
                        const matches = (lowerMessage.match(new RegExp(keyword, 'g')) || []).length;
                        score += matches;
                    });
                    
                    if (score > 0) {
                        topicScores[topic] = score;
                    }
                }
                
                // Sort topics by relevance score
                const sortedTopics = Object.entries(topicScores)
                    .sort(([,a], [,b]) => b - a)
                    .map(([topic]) => topic);
                
                return sortedTopics;
            }

            assessComplexity(message) {
                const complexityIndicators = {
                    'basic': 1,
                    'intermediate': 2,
                    'advanced': 3,
                    'expert': 4
                };
                
                let complexityScore = 1;
                const lowerMessage = message.toLowerCase();
                
                // Check for complexity indicators
                const basicWords = ['what is', 'simple', 'basic', 'easy', 'help me understand'];
                const intermediateWords = ['solve', 'find', 'calculate', 'show steps', 'explain how'];
                const advancedWords = ['prove', 'derive', 'analyze', 'optimize', 'theorem'];
                const expertWords = ['lemma', 'corollary', 'abstract', 'generalize', 'rigorous proof'];
                
                if (expertWords.some(word => lowerMessage.includes(word))) complexityScore = 4;
                else if (advancedWords.some(word => lowerMessage.includes(word))) complexityScore = 3;
                else if (intermediateWords.some(word => lowerMessage.includes(word))) complexityScore = 2;
                else if (basicWords.some(word => lowerMessage.includes(word))) complexityScore = 1;
                
                // Adjust based on mathematical notation complexity
                const mathNotationComplexity = this.assessMathNotationComplexity(message);
                complexityScore = Math.max(complexityScore, mathNotationComplexity);
                
                const complexityLevels = ['basic', 'intermediate', 'advanced', 'expert'];
                return complexityLevels[Math.min(complexityScore - 1, 3)];
            }

            assessMathNotationComplexity(message) {
                let complexity = 1;
                
                // Check for various mathematical notations
                if (message.match(/[∫∑∏∂∇]/)) complexity = Math.max(complexity, 4); // Advanced calculus
                if (message.match(/[αβγδεθλπσφχψω]/)) complexity = Math.max(complexity, 3); // Greek letters
                if (message.match(/\^[2-9]|\^{.*}/)) complexity = Math.max(complexity, 2); // Exponents
                if (message.match(/\√|\∛/)) complexity = Math.max(complexity, 2); // Roots
                if (message.match(/[<>≤≥≠≈]/)) complexity = Math.max(complexity, 2); // Inequalities
                if (message.match(/\|.*\|/)) complexity = Math.max(complexity, 2); // Absolute value/determinant
                
                return complexity;
            }

            identifyLearningIntent(message) {
                const intentPatterns = {
                    'understand_concept': ['understand', 'concept', 'idea', 'meaning', 'intuition', 'why does'],
                    'solve_problem': ['solve', 'answer', 'find', 'calculate', 'compute'],
                    'learn_method': ['how to', 'method', 'technique', 'approach', 'strategy'],
                    'verify_solution': ['check', 'verify', 'correct', 'right', 'wrong', 'mistake'],
                    'explore_applications': ['use', 'apply', 'real world', 'example', 'practical'],
                    'prepare_exam': ['test', 'exam', 'quiz', 'homework', 'assignment'],
                    'build_foundation': ['basics', 'foundation', 'start', 'beginning', 'introduction']
                };
                
                const lowerMessage = message.toLowerCase();
                
                for (const [intent, patterns] of Object.entries(intentPatterns)) {
                    if (patterns.some(pattern => lowerMessage.includes(pattern))) {
                        return intent;
                    }
                }
                
                return 'general_inquiry';
            }

            detectEmotionalCues(message) {
                const emotionalIndicators = {
                    'confident': ['i think', 'i believe', 'should be', 'obviously'],
                    'confused': ['confused', 'don\'t understand', 'lost', 'stuck', '?', 'help'],
                    'frustrated': ['can\'t', 'impossible', 'makes no sense', 'stupid', 'hate'],
                    'curious': ['interesting', 'wonder', 'what if', 'explore', 'learn more'],
                    'anxious': ['worried', 'nervous', 'test', 'exam', 'deadline'],
                    'excited': ['love', 'amazing', 'cool', 'awesome', 'fascinating']
                };
                
                const lowerMessage = message.toLowerCase();
                const detectedEmotions = [];
                
                for (const [emotion, indicators] of Object.entries(emotionalIndicators)) {
                    if (indicators.some(indicator => lowerMessage.includes(indicator))) {
                        detectedEmotions.push(emotion);
                    }
                }
                
                return detectedEmotions.length > 0 ? detectedEmotions : ['neutral'];
            }

            identifyMathPatterns(message) {
                const patterns = [];
                
                // Check for common mathematical patterns
                if (message.match(/\d+x\s*[\+\-]\s*\d+\s*=\s*\d+/)) patterns.push('linear_equation');
                if (message.match(/x\^?2|x²/)) patterns.push('quadratic');
                if (message.match(/\d+x\^?\d+/)) patterns.push('polynomial');
                if (message.match(/sin|cos|tan/)) patterns.push('trigonometric');
                if (message.match(/\d+\/\d+/)) patterns.push('fraction');
                if (message.match(/√|\sqrt/)) patterns.push('radical');
                if (message.match(/log|ln/)) patterns.push('logarithmic');
                if (message.match(/\d+\^|e\^|exp/)) patterns.push('exponential');
                if (message.match(/\d+!/)) patterns.push('factorial');
                if (message.match(/\|\s*.*\s*\|/)) patterns.push('absolute_value');
                
                return patterns;
            }

            determineSolvingApproach(questionType, difficulty, topics) {
                const approaches = {
                    'step_by_step': ['problem_solving', 'verification'],
                    'conceptual': ['explanation', 'application'],
                    'visual': ['geometry', 'trigonometry'],
                    'analytical': ['calculus', 'algebra'],
                    'computational': ['arithmetic', 'statistics']
                };
                
                let recommendedApproach = 'step_by_step'; // default
                
                // Choose approach based on question type
                for (const [approach, types] of Object.entries(approaches)) {
                    if (types.includes(questionType)) {
                        recommendedApproach = approach;
                        break;
                    }
                }
                
                // Adjust based on topics
                if (topics.includes('geometry')) recommendedApproach = 'visual';
                if (topics.includes('calculus') && difficulty === 'advanced') recommendedApproach = 'analytical';
                
                return recommendedApproach;
            }

            checkPrerequisites(topics) {
                const prerequisites = {
                    'calculus': ['algebra', 'precalculus', 'trigonometry'],
                    'linear_algebra': ['algebra', 'geometry'],
                    'statistics': ['arithmetic', 'algebra'],
                    'trigonometry': ['geometry', 'algebra'],
                    'precalculus': ['algebra', 'geometry']
                };
                
                const userKnowledge = Object.keys(this.learningAnalytics.topicFrequency);
                const missingPrereqs = {};
                
                topics.forEach(topic => {
                    if (prerequisites[topic]) {
                        const missing = prerequisites[topic].filter(prereq => 
                            !userKnowledge.includes(prereq) || 
                            this.learningAnalytics.topicFrequency[prereq] < 3
                        );
                        
                        if (missing.length > 0) {
                            missingPrereqs[topic] = missing;
                        }
                    }
                });
                
                return {
                    met: Object.keys(missingPrereqs).length === 0,
                    missing: missingPrereqs
                };
            }

            assessDifficultyLevel(message) {
                const difficultyIndicators = {
                    'beginner': ['basic', 'simple', 'easy', 'introduce', 'what is', 'help me understand'],
                    'intermediate': ['solve', 'find', 'calculate', 'determine', 'explain how'],
                    'advanced': ['prove', 'derive', 'complex', 'advanced', 'theorem', 'lemma', 'optimization']
                };
                
                const lowerMessage = message.toLowerCase();
                
                for (const [level, indicators] of Object.entries(difficultyIndicators)) {
                    if (indicators.some(indicator => lowerMessage.includes(indicator))) {
                        return level;
                    }
                }
                
                return 'intermediate'; // default
            }

            classifyQuestionType(message) {
                const questionTypes = {
                    'problem_solving': ['solve', 'find', 'calculate', 'determine'],
                    'explanation': ['explain', 'why', 'how', 'what is', 'tell me about'],
                    'verification': ['check', 'correct', 'right', 'verify', 'is this'],
                    'application': ['use', 'apply', 'real world', 'example', 'practical']
                };
                
                const lowerMessage = message.toLowerCase();
                
                for (const [type, keywords] of Object.entries(questionTypes)) {
                    if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                        return type;
                    }
                }
                
                return 'general';
            }

            adaptLearningStyle(userFeedback) {
                // Enhanced adaptation with deeper analysis
                if (userFeedback.includes('too complicated') || userFeedback.includes('simpler')) {
                    this.userProfile.responsePreferences.detailLevel = 'brief';
                    this.userProfile.difficultyLevel = 'beginner';
                } else if (userFeedback.includes('more detail') || userFeedback.includes('explain more')) {
                    this.userProfile.responsePreferences.detailLevel = 'detailed';
                }
                
                if (userFeedback.includes('visual') || userFeedback.includes('diagram')) {
                    this.userProfile.responsePreferences.visualAids = true;
                    this.userProfile.learningStyle = 'visual';
                }
                
                if (userFeedback.includes('step by step') || userFeedback.includes('steps')) {
                    this.userProfile.responsePreferences.stepByStep = true;
                    this.userProfile.learningStyle = 'step-by-step';
                }
                
                // Detect learning style preferences from feedback patterns
                if (userFeedback.includes('formula') || userFeedback.includes('equation')) {
                    this.userProfile.learningStyle = 'analytical';
                }
                
                if (userFeedback.includes('example') || userFeedback.includes('practice')) {
                    this.userProfile.responsePreferences.examplesPreferred = true;
                }
            }

            adaptLearningPath(topics, difficulty, complexity, learningIntent) {
                // Advanced learning path adaptation
                const currentLevel = this.calculateCurrentLevel(topics);
                const optimalDifficulty = this.calculateOptimalDifficulty(currentLevel, complexity);
                
                // Update user strengths and weaknesses based on patterns
                this.updateUserCapabilities(topics, difficulty, complexity);
                
                // Adjust response preferences based on success patterns
                this.optimizeResponseStyle(learningIntent, topics);
                
                // Update learning trajectory
                this.updateLearningTrajectory(topics, difficulty);
                
                // Set session focus based on analysis
                this.contextMemory.sessionFocus = this.determineSessionFocus(topics, learningIntent);
            }

            calculateCurrentLevel(topics) {
                let totalInteractions = 0;
                let weightedLevel = 0;
                
                topics.forEach(topic => {
                    const frequency = this.learningAnalytics.topicFrequency[topic] || 0;
                    const successRate = this.learningAnalytics.successRate[topic] ? 
                        this.learningAnalytics.successRate[topic].success / this.learningAnalytics.successRate[topic].total : 0.5;
                    
                    totalInteractions += frequency;
                    weightedLevel += frequency * successRate * this.getTopicComplexityWeight(topic);
                });
                
                if (totalInteractions === 0) return 'beginner';
                
                const averageLevel = weightedLevel / totalInteractions;
                
                if (averageLevel < 0.3) return 'beginner';
                if (averageLevel < 0.6) return 'intermediate';
                if (averageLevel < 0.8) return 'advanced';
                return 'expert';
            }

            getTopicComplexityWeight(topic) {
                const complexityWeights = {
                    'arithmetic': 0.2,
                    'algebra': 0.4,
                    'geometry': 0.5,
                    'trigonometry': 0.6,
                    'precalculus': 0.7,
                    'calculus': 0.8,
                    'linear_algebra': 0.9,
                    'discrete_math': 0.85,
                    'number_theory': 0.95,
                    'statistics': 0.6
                };
                
                return complexityWeights[topic] || 0.5;
            }

            calculateOptimalDifficulty(currentLevel, requestedComplexity) {
                const levelMap = { 'beginner': 1, 'intermediate': 2, 'advanced': 3, 'expert': 4 };
                const complexityMap = { 'basic': 1, 'intermediate': 2, 'advanced': 3, 'expert': 4 };
                
                const currentLevelNum = levelMap[currentLevel];
                const requestedNum = complexityMap[requestedComplexity];
                
                // Optimal challenge: slightly above current level but not overwhelming
                const optimal = Math.min(currentLevelNum + 1, requestedNum + 1, 4);
                
                const reverseMap = { 1: 'basic', 2: 'intermediate', 3: 'advanced', 4: 'expert' };
                return reverseMap[optimal];
            }

            updateUserCapabilities(topics, difficulty, complexity) {
                topics.forEach(topic => {
                    const complexityScore = this.getComplexityScore(complexity);
                    
                    // Track progression in each topic
                    if (!this.userProfile.topicProgression) {
                        this.userProfile.topicProgression = {};
                    }
                    
                    if (!this.userProfile.topicProgression[topic]) {
                        this.userProfile.topicProgression[topic] = {
                            maxComplexity: complexityScore,
                            averageComplexity: complexityScore,
                            interactions: 1
                        };
                    } else {
                        const prog = this.userProfile.topicProgression[topic];
                        prog.maxComplexity = Math.max(prog.maxComplexity, complexityScore);
                        prog.averageComplexity = ((prog.averageComplexity * prog.interactions) + complexityScore) / (prog.interactions + 1);
                        prog.interactions += 1;
                    }
                    
                    // Update strengths and weaknesses
                    if (complexityScore >= 3) {
                        if (!this.contextMemory.userStrengths.includes(topic)) {
                            this.contextMemory.userStrengths.push(topic);
                        }
                        this.contextMemory.userWeaknesses = this.contextMemory.userWeaknesses.filter(t => t !== topic);
                    } else if (complexityScore === 1) {
                        if (!this.contextMemory.userWeaknesses.includes(topic)) {
                            this.contextMemory.userWeaknesses.push(topic);
                        }
                    }
                });
            }

            getComplexityScore(complexity) {
                const scores = { 'basic': 1, 'intermediate': 2, 'advanced': 3, 'expert': 4 };
                return scores[complexity] || 2;
            }

            optimizeResponseStyle(learningIntent, topics) {
                // Adapt response style based on learning intent
                switch (learningIntent) {
                    case 'understand_concept':
                        this.userProfile.responsePreferences.detailLevel = 'detailed';
                        this.userProfile.responsePreferences.examplesPreferred = true;
                        break;
                    case 'solve_problem':
                        this.userProfile.responsePreferences.stepByStep = true;
                        break;
                    case 'verify_solution':
                        this.userProfile.responsePreferences.detailLevel = 'medium';
                        break;
                    case 'explore_applications':
                        this.userProfile.responsePreferences.examplesPreferred = true;
                        this.userProfile.responsePreferences.detailLevel = 'detailed';
                        break;
                }
                
                // Topic-specific adaptations
                if (topics.includes('geometry')) {
                    this.userProfile.responsePreferences.visualAids = true;
                }
                
                if (topics.includes('calculus') || topics.includes('algebra')) {
                    this.userProfile.responsePreferences.stepByStep = true;
                }
            }

            updateLearningTrajectory(topics, difficulty) {
                if (!this.learningAnalytics.learningTrajectory) {
                    this.learningAnalytics.learningTrajectory = [];
                }
                
                this.learningAnalytics.learningTrajectory.push({
                    topics: topics,
                    difficulty: difficulty,
                    timestamp: new Date().toISOString(),
                    sessionId: this.getSessionId()
                });
                
                // Keep only recent trajectory data (last 50 interactions)
                if (this.learningAnalytics.learningTrajectory.length > 50) {
                    this.learningAnalytics.learningTrajectory = 
                        this.learningAnalytics.learningTrajectory.slice(-50);
                }
            }

            getSessionId() {
                if (!this.sessionId) {
                    this.sessionId = 'session_' + Date.now();
                }
                return this.sessionId;
            }

            determineSessionFocus(topics, learningIntent) {
                // Determine what the user is trying to accomplish this session
                const recentProblems = this.contextMemory.recentProblems.slice(-5);
                const commonTopics = this.findCommonTopics(recentProblems);
                
                if (commonTopics.length > 0) {
                    return {
                        primaryTopic: commonTopics[0],
                        intent: learningIntent,
                        approach: this.recommendLearningApproach(commonTopics[0], learningIntent)
                    };
                }
                
                return {
                    primaryTopic: topics[0] || 'general',
                    intent: learningIntent,
                    approach: 'exploratory'
                };
            }

            findCommonTopics(problems) {
                const topicCounts = {};
                
                problems.forEach(problem => {
                    if (problem.topics) {
                        problem.topics.forEach(topic => {
                            topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                        });
                    }
                });
                
                return Object.entries(topicCounts)
                    .sort(([,a], [,b]) => b - a)
                    .map(([topic]) => topic);
            }

            recommendLearningApproach(topic, intent) {
                const approaches = {
                    'algebra': {
                        'understand_concept': 'conceptual_foundation',
                        'solve_problem': 'systematic_solving',
                        'learn_method': 'technique_mastery'
                    },
                    'calculus': {
                        'understand_concept': 'intuitive_understanding',
                        'solve_problem': 'step_by_step_derivation',
                        'learn_method': 'rule_application'
                    },
                    'geometry': {
                        'understand_concept': 'visual_reasoning',
                        'solve_problem': 'geometric_analysis',
                        'learn_method': 'theorem_application'
                    }
                };
                
                return approaches[topic] && approaches[topic][intent] || 'adaptive_teaching';
            }

            generateEnhancedSystemPrompt(userMessage) {
                const analysis = this.analyzeUserInput(userMessage);
                const recentTopics = this.contextMemory.recentProblems
                    .slice(-5)
                    .map(p => p.topics)
                    .flat();
                
                const currentLevel = this.calculateCurrentLevel(analysis.topics);
                const sessionFocus = this.contextMemory.sessionFocus;
                
                let systemPrompt = `You are an expert mathematics tutor with advanced adaptive AI capabilities and deep analytical thinking. `;
                
                // Add sophisticated context from analysis
                if (recentTopics.length > 0) {
                    const topicFrequency = {};
                    recentTopics.forEach(topic => {
                        topicFrequency[topic] = (topicFrequency[topic] || 0) + 1;
                    });
                    const dominantTopics = Object.entries(topicFrequency)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 3)
                        .map(([topic]) => topic);
                    
                    systemPrompt += `Recent session context: The student has been focusing on ${dominantTopics.join(', ')}. `;
                }
                
                // Add learning profile with AI insights
                systemPrompt += `Student Profile: `;
                systemPrompt += `Learning level: ${currentLevel} (${this.userProfile.difficultyLevel}), `;
                systemPrompt += `Learning style: ${this.userProfile.learningStyle}, `;
                systemPrompt += `Response preferences: ${this.userProfile.responsePreferences.detailLevel} detail, `;
                systemPrompt += `${this.userProfile.responsePreferences.stepByStep ? 'step-by-step approach' : 'conceptual approach'}, `;
                systemPrompt += `${this.userProfile.responsePreferences.examplesPreferred ? 'example-rich' : 'theory-focused'}. `;
                
                // Add complexity and emotional intelligence
                if (analysis.complexity) {
                    systemPrompt += `Complexity level needed: ${analysis.complexity}. `;
                }
                
                if (analysis.emotionalCues && analysis.emotionalCues[0] !== 'neutral') {
                    systemPrompt += `Student emotional state: ${analysis.emotionalCues.join(', ')} - adapt tone accordingly. `;
                }
                
                // Add learning intent guidance
                if (analysis.learningIntent && analysis.learningIntent !== 'general_inquiry') {
                    const intentInstructions = {
                        'understand_concept': 'Focus on building deep conceptual understanding with intuitive explanations.',
                        'solve_problem': 'Provide systematic problem-solving approach with clear steps.',
                        'learn_method': 'Teach techniques and methods with practice opportunities.',
                        'verify_solution': 'Check work carefully and provide constructive feedback.',
                        'explore_applications': 'Show real-world applications and practical examples.',
                        'prepare_exam': 'Focus on key concepts and problem-solving strategies for assessment.',
                        'build_foundation': 'Start with fundamentals and build up systematically.'
                    };
                    
                    systemPrompt += intentInstructions[analysis.learningIntent] + ' ';
                }
                
                // Add topic-specific expertise
                if (analysis.topics.length > 0) {
                    systemPrompt += `Mathematical focus: ${analysis.topics.join(' and ')} expertise required. `;
                    
                    // Add prerequisite awareness
                    if (!analysis.prerequisiteCheck.met) {
                        const missingTopics = Object.values(analysis.prerequisiteCheck.missing).flat();
                        systemPrompt += `Note: Student may need review of ${missingTopics.join(', ')} concepts. `;
                    }
                }
                
                // Add solving approach guidance
                if (analysis.problemSolvingApproach) {
                    const approachInstructions = {
                        'step_by_step': 'Break down the solution into clear, logical steps.',
                        'conceptual': 'Emphasize understanding over computation.',
                        'visual': 'Use visual descriptions and spatial reasoning.',
                        'analytical': 'Focus on mathematical rigor and formal methods.',
                        'computational': 'Show calculations clearly with proper notation.'
                    };
                    
                    systemPrompt += approachInstructions[analysis.problemSolvingApproach] + ' ';
                }
                
                // Add pattern recognition insights
                if (analysis.patterns && analysis.patterns.length > 0) {
                    systemPrompt += `Mathematical patterns identified: ${analysis.patterns.join(', ')} - leverage these in explanation. `;
                }
                
                // Add session continuity
                if (sessionFocus && sessionFocus.primaryTopic) {
                    systemPrompt += `Session focus: Continue building expertise in ${sessionFocus.primaryTopic} with ${sessionFocus.approach} approach. `;
                }
                
                // Add adaptive learning feedback
                const strengths = this.contextMemory.userStrengths;
                const weaknesses = this.contextMemory.userWeaknesses;
                
                if (strengths.length > 0) {
                    systemPrompt += `Student strengths: ${strengths.join(', ')} - leverage these for confidence. `;
                }
                
                if (weaknesses.length > 0) {
                    systemPrompt += `Areas needing support: ${weaknesses.join(', ')} - provide extra scaffolding. `;
                }
                
                // Final instructions with enhanced AI thinking
                systemPrompt += `Use formatting like **bold** for emphasis. Be encouraging and educational. `;
                systemPrompt += `Think step by step, show your reasoning process, and adapt your teaching to this student's unique learning profile. `;
                systemPrompt += `Build on previous conversation context and demonstrate deep mathematical understanding while making concepts accessible.`;
                
                return systemPrompt;
            }

            recordUserSuccess(topic, method) {
                if (!this.userProfile.successfulMethods.includes(method)) {
                    this.userProfile.successfulMethods.push(method);
                }
                
                if (!this.learningAnalytics.successRate[topic]) {
                    this.learningAnalytics.successRate[topic] = { success: 0, total: 0 };
                }
                this.learningAnalytics.successRate[topic].success++;
                this.learningAnalytics.successRate[topic].total++;
                
                this.saveUserProfile();
            }

            recordUserDifficulty(topic, issue) {
                if (!this.userProfile.commonMistakes.includes(issue)) {
                    this.userProfile.commonMistakes.push(issue);
                }
                
                if (!this.contextMemory.userWeaknesses.includes(topic)) {
                    this.contextMemory.userWeaknesses.push(topic);
                }
                
                if (!this.learningAnalytics.successRate[topic]) {
                    this.learningAnalytics.successRate[topic] = { success: 0, total: 0 };
                }
                this.learningAnalytics.successRate[topic].total++;
                
                this.saveUserProfile();
            }

            generatePersonalizedSuggestions() {
                const suggestions = [];
                
                // Suggest based on frequent topics
                const topTopics = Object.entries(this.learningAnalytics.topicFrequency)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([topic]) => topic);
                
                if (topTopics.length > 0) {
                    suggestions.push(`Continue practicing ${topTopics[0]} - you've been focusing on this area.`);
                }
                
                // Suggest based on weaknesses
                if (this.contextMemory.userWeaknesses.length > 0) {
                    const weakness = this.contextMemory.userWeaknesses[0];
                    suggestions.push(`Let's work on ${weakness} - I can help strengthen this area.`);
                }
                
                // Suggest based on success rate
                const strugglingTopics = Object.entries(this.learningAnalytics.successRate)
                    .filter(([topic, stats]) => stats.success / stats.total < 0.6)
                    .map(([topic]) => topic);
                
                if (strugglingTopics.length > 0) {
                    suggestions.push(`Would you like extra practice with ${strugglingTopics[0]}?`);
                }
                
                return suggestions;
            }

            handleSendMessage(messageText = null) {
                const text = messageText || this.chatInput.value.trim();
                if (!text || this.isTyping) return;

                // Analyze user input for learning adaptation
                const analysis = this.analyzeUserInput(text);
                
                this.addMessage('user', text);
                this.chatInput.value = '';
                this.hideSampleProblems();
                
                // Show typing indicator with personalized message
                this.showTypingIndicator(analysis.topics[0]);
                
                // Use enhanced OpenAI API if key is available, otherwise use enhanced demo responses
                if (this.apiKey) {
                    this.getEnhancedOpenAIResponse(text);
                } else {
                    // Enhanced demo response with learning adaptation
                    setTimeout(() => {
                        this.hideTypingIndicator();
                        const response = this.generateEnhancedAIResponse(text, analysis);
                        this.addMessage('ai', response);
                    }, 1000 + Math.random() * 2000);
                }
                
                // Save user interaction data
                this.saveUserProfile();
            }

            async getEnhancedOpenAIResponse(userMessage) {
                try {
                    // Generate enhanced system prompt with ML insights
                    const systemPrompt = this.generateEnhancedSystemPrompt(userMessage);
                    
                    // Build conversation context from recent messages
                    const conversationMessages = [
                        { role: 'system', content: systemPrompt }
                    ];
                    
                    // Add recent conversation history for context
                    const recentMessages = this.conversationHistory.slice(-6); // Last 3 exchanges
                    conversationMessages.push(...recentMessages);
                    
                    // Add current user message
                    conversationMessages.push({ role: 'user', content: userMessage });
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: conversationMessages,
                            max_tokens: 600,
                            temperature: 0.7,
                            presence_penalty: 0.1,
                            frequency_penalty: 0.1
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('Invalid API key. Please check your OpenAI API key.');
                        } else if (response.status === 429) {
                            throw new Error('Rate limit exceeded. Please try again in a moment.');
                        } else {
                            throw new Error(`API request failed: ${response.status}`);
                        }
                    }

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    
                    // Store conversation in history for context
                    this.conversationHistory.push(
                        { role: 'user', content: userMessage },
                        { role: 'assistant', content: aiResponse }
                    );
                    
                    // Keep conversation history manageable (last 20 messages)
                    if (this.conversationHistory.length > 20) {
                        this.conversationHistory = this.conversationHistory.slice(-20);
                    }
                    
                    this.hideTypingIndicator();
                    this.addMessage('ai', aiResponse);
                    
                    // Analyze response success and learn from it
                    this.analyzeResponseSuccess(userMessage, aiResponse);

                } catch (error) {
                    console.error('OpenAI API Error:', error);
                    this.hideTypingIndicator();
                    
                    let errorMessage = 'Sorry, I encountered an error while processing your request. ';
                    
                    if (error.message.includes('Invalid API key')) {
                        errorMessage += 'Please check your API key configuration.';
                    } else if (error.message.includes('Rate limit')) {
                        errorMessage += 'Please wait a moment and try again.';
                    } else {
                        errorMessage += 'Please try again or use demo mode.';
                    }
                    
                    this.addMessage('ai', errorMessage);
                    this.showToast('❌ ' + error.message);
                }
            }

            analyzeResponseSuccess(userMessage, aiResponse) {
                // Simple heuristic to gauge if response was likely helpful
                const analysis = this.analyzeUserInput(userMessage);
                
                if (analysis.topics.length > 0) {
                    const mainTopic = analysis.topics[0];
                    
                    // If response contains step-by-step indicators, likely successful
                    if (aiResponse.includes('Step') || aiResponse.includes('**') || aiResponse.length > 200) {
                        this.recordUserSuccess(mainTopic, 'detailed_explanation');
                    }
                }
                
                // Update preferred explanation types based on response format
                if (aiResponse.includes('**Step')) {
                    this.learningAnalytics.preferredExplanationTypes.stepByStep = 
                        (this.learningAnalytics.preferredExplanationTypes.stepByStep || 0) + 1;
                }
                
                this.saveUserProfile();
            }

            hideSampleProblems() {
                const sampleProblems = document.getElementById('sampleProblems');
                if (sampleProblems) {
                    sampleProblems.style.display = 'none';
                }
            }

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex gap-4 ${type === 'user' ? 'justify-end' : 'justify-start'} message-fade-in`;
                
                const timestamp = new Date().toLocaleTimeString();
                
                if (type === 'ai') {
                    messageDiv.innerHTML = `
                        <div class="relative w-10 h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center flex-shrink-0 mt-1 shadow-lg shadow-emerald-500/30">
                            <svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <div class="absolute inset-0 bg-emerald-400/25 rounded-xl blur-sm"></div>
                        </div>
                        
                        <div class="relative max-w-2xl p-5 bg-slate-800/40 backdrop-blur-xl border border-emerald-500/25 rounded-2xl">
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/8 to-transparent rounded-2xl"></div>
                            <div class="relative">
                                <div class="text-slate-200 leading-relaxed whitespace-pre-line">${this.formatMessage(content)}</div>
                                <div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-700/30">
                                    <span class="text-xs text-slate-500">${timestamp}</span>
                                    <div class="flex items-center gap-2">
                                        <button class="copy-btn w-6 h-6 p-0 text-slate-500 hover:text-emerald-400 hover:bg-emerald-500/10 rounded transition-colors" title="Copy message">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                        <button class="w-6 h-6 p-0 text-slate-500 hover:text-emerald-400 hover:bg-emerald-500/10 rounded transition-colors" title="Helpful">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="relative max-w-2xl p-5 bg-emerald-500/10 backdrop-blur-xl border border-emerald-500/30 rounded-2xl ml-auto">
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/8 to-emerald-400/5 rounded-2xl"></div>
                            <div class="relative">
                                <p class="text-emerald-100 leading-relaxed">${content}</p>
                                <div class="flex items-center justify-end mt-3 pt-3 border-t border-slate-700/30">
                                    <span class="text-xs text-slate-500">${timestamp}</span>
                                </div>
                            </div>
                        </div>

                        <div class="w-10 h-10 flex-shrink-0 mt-1 border border-amber-400/30 rounded-full bg-slate-800 flex items-center justify-center">
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    `;
                }

                this.chatContainer.appendChild(messageDiv);
                
                // Add copy functionality for AI messages
                if (type === 'ai') {
                    const copyBtn = messageDiv.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(content);
                            this.showToast('Message copied to clipboard!');
                        });
                    }
                }

                this.scrollToBottom();
            }

            formatMessage(content) {
                // Format bold text (**text**)
                return content.replace(/\*\*(.*?)\*\*/g, '<span class="font-semibold text-emerald-300">$1</span>');
            }

            showTypingIndicator(topic = null) {
                this.isTyping = true;
                this.sendBtn.disabled = true;
                this.chatInput.disabled = true;
                
                const sophisticatedMessages = {
                    'algebra': [
                        'Analyzing algebraic patterns and structures...',
                        'Processing equation relationships and solutions...',
                        'Thinking through step-by-step algebraic reasoning...',
                        'Evaluating mathematical expressions and variables...'
                    ],
                    'calculus': [
                        'Computing derivatives and rate of change concepts...',
                        'Analyzing limits and continuity principles...',
                        'Processing integral calculus and area calculations...',
                        'Thinking through advanced calculus applications...'
                    ],
                    'geometry': [
                        'Visualizing geometric shapes and spatial relationships...',
                        'Computing areas, volumes, and geometric measurements...',
                        'Analyzing angles, theorems, and proofs...',
                        'Processing coordinate geometry and transformations...'
                    ],
                    'statistics': [
                        'Processing data patterns and statistical relationships...',
                        'Computing probabilities and distributions...',
                        'Analyzing statistical measures and correlations...',
                        'Thinking through data interpretation strategies...'
                    ],
                    'trigonometry': [
                        'Computing trigonometric functions and identities...',
                        'Analyzing angle relationships and unit circle concepts...',
                        'Processing wave functions and periodic patterns...',
                        'Thinking through triangle relationships and applications...'
                    ]
                };
                
                const generalMessages = [
                    'Engaging advanced mathematical reasoning...',
                    'Processing your question with AI intelligence...',
                    'Analyzing mathematical concepts and relationships...',
                    'Thinking through problem-solving strategies...',
                    'Computing optimal learning approach...',
                    'Evaluating complexity and context patterns...'
                ];
                
                const messages = sophisticatedMessages[topic] || generalMessages;
                const thinkingMessage = messages[Math.floor(Math.random() * messages.length)];
                
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex gap-4 justify-start';
                typingDiv.innerHTML = `
                    <div class="relative w-10 h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center flex-shrink-0 mt-1 shadow-lg shadow-emerald-500/30">
                        <svg class="w-5 h-5 text-slate-900 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <div class="absolute inset-0 bg-emerald-400/25 rounded-xl blur-sm animate-pulse"></div>
                    </div>
                    
                    <div class="relative max-w-2xl p-5 bg-slate-800/40 backdrop-blur-xl border border-emerald-500/25 rounded-2xl">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/8 to-transparent rounded-2xl"></div>
                        <div class="relative flex items-center gap-3">
                            <div class="flex gap-1">
                                <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot animate-bounce" style="animation-delay: 0ms"></div>
                                <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot animate-bounce" style="animation-delay: 150ms"></div>
                                <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot animate-bounce" style="animation-delay: 300ms"></div>
                            </div>
                            <span class="text-slate-300 text-sm font-medium">🧠 ${thinkingMessage}</span>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(typingDiv);
                this.scrollToBottom();
                
                // Add a realistic thinking delay based on complexity
                const thinkingTime = topic ? 2000 + Math.random() * 1500 : 1500 + Math.random() * 1000;
                this.thinkingStartTime = Date.now();
                this.expectedThinkingDuration = thinkingTime;
            }

            hideTypingIndicator() {
                this.isTyping = false;
                this.sendBtn.disabled = false;
                this.chatInput.disabled = false;
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            generateAIResponse(userInput) {
                const input = userInput.toLowerCase();
                const demoPrefix = "**[Demo Mode]** ";
                
                if (input.includes("2x + 5 = 15")) {
                    return demoPrefix + "Great! Let's solve this step-by-step:\n\n**Step 1:** Subtract 5 from both sides\n2x + 5 - 5 = 15 - 5\n2x = 10\n\n**Step 2:** Divide both sides by 2\n2x ÷ 2 = 10 ÷ 2\nx = 5\n\n**Answer:** x = 5\n\nWould you like me to show you how to check this answer?";
                } else if (input.includes("derivative") && input.includes("x²")) {
                    return demoPrefix + "I'll find the derivative of f(x) = x² + 3x - 2 using the power rule:\n\n**Power Rule:** d/dx[xⁿ] = n·xⁿ⁻¹\n\n**Step 1:** d/dx[x²] = 2x¹ = 2x\n**Step 2:** d/dx[3x] = 3\n**Step 3:** d/dx[-2] = 0 (constant rule)\n\n**Answer:** f'(x) = 2x + 3\n\nWould you like to practice with another derivative?";
                } else if (input.includes("area") && input.includes("circle")) {
                    return demoPrefix + "To find the area of a circle with radius 5:\n\n**Formula:** A = πr²\n\n**Given:** r = 5\n\n**Solution:**\nA = π × 5²\nA = π × 25\nA = 25π\n\n**Approximate value:** 25π ≈ 78.54 square units\n\nRemember: Always leave π in your answer unless asked for a decimal approximation!";
                } else if (input.includes("quadratic formula")) {
                    return demoPrefix + "The quadratic formula is used to solve equations of the form ax² + bx + c = 0:\n\n**Formula:** x = (-b ± √(b² - 4ac)) / (2a)\n\n**Components:**\n• a, b, c are coefficients\n• The ± means there are usually two solutions\n• b² - 4ac is called the discriminant\n\nWould you like to see an example of how to use this formula?";
                } else if (input.includes("factor") && input.includes("x² - 9")) {
                    return demoPrefix + "x² - 9 is a difference of squares! Here's how to factor it:\n\n**Pattern:** a² - b² = (a + b)(a - b)\n\n**Step 1:** Identify the squares\nx² - 9 = x² - 3²\n\n**Step 2:** Apply the formula\nx² - 3² = (x + 3)(x - 3)\n\n**Answer:** x² - 9 = (x + 3)(x - 3)\n\n**Check:** (x + 3)(x - 3) = x² - 3x + 3x - 9 = x² - 9 ✓";
                } else if (input.includes("algebra")) {
                    return demoPrefix + "Algebra is all about finding unknown values using mathematical operations! Here are some key concepts:\n\n**Core Principles:**\n• Whatever you do to one side, do to the other\n• Isolate the variable using inverse operations\n• Simplify step by step\n\n**Common Topics:**\n• Linear equations (like 2x + 5 = 15)\n• Factoring (like x² - 9)\n• Systems of equations\n• Functions and graphing\n\nWhat specific algebra topic would you like to explore?";
                } else if (input.includes("calculus")) {
                    return demoPrefix + "Calculus is the mathematics of change and motion! Let me break it down:\n\n**Two Main Branches:**\n• **Differential Calculus** - Finding rates of change (derivatives)\n• **Integral Calculus** - Finding areas and accumulations\n\n**Key Concepts:**\n• Limits - The foundation of calculus\n• Derivatives - Rate of change at a point\n• Integrals - Area under curves\n\n**Applications:**\n• Physics (motion, forces)\n• Economics (optimization)\n• Engineering (design)\n\nWhat aspect of calculus interests you most?";
                } else if (input.includes("geometry")) {
                    return demoPrefix + "Geometry is the study of shapes, sizes, and spatial relationships! Here's what I can help with:\n\n**Areas of Focus:**\n• **2D Shapes** - Triangles, circles, polygons\n• **3D Solids** - Spheres, cubes, cylinders\n• **Measurements** - Area, perimeter, volume\n• **Relationships** - Similar figures, congruence\n\n**Common Formulas:**\n• Circle: A = πr², C = 2πr\n• Triangle: A = ½bh\n• Rectangle: A = lw\n\nWhat geometry problem are you working on?";
                } else if (input.includes("help") || input.includes("how")) {
                    return demoPrefix + "I'm here to provide step-by-step guidance! In demo mode, I can help with basic problems. For advanced AI tutoring, please configure your OpenAI API key.\n\n� **Available in Demo Mode:**\n• Basic algebra problems\n• Simple calculus derivatives\n• Common geometry formulas\n• Pre-programmed explanations\n\n� **With API Key:**\n• Advanced problem solving\n• Personalized explanations\n• Complex mathematical concepts\n• Real-time AI responses\n\nJust share your problem or click 'API Key' to upgrade!";
                } else {
                    return demoPrefix + `That's a great question about mathematics! In demo mode, I have limited pre-programmed responses. For comprehensive help with this topic, please configure your OpenAI API key.\n\n**Demo Mode Available:**\n• Basic equation solving\n• Simple derivatives\n• Common formulas\n\n**Need Full AI Tutoring?**\nClick the 'API Key' button to configure OpenAI access for advanced, personalized math tutoring!\n\nOr try one of the sample problems below.`;
                }
            }

            // Enhanced AI Response with Advanced Machine Learning
            generateEnhancedAIResponse(userInput, analysis) {
                const input = userInput.toLowerCase();
                const demoPrefix = "**[Demo Mode - Advanced AI]** ";
                
                // Deep analysis of user input
                const complexity = analysis.complexity || 'intermediate';
                const learningIntent = analysis.learningIntent || 'general_inquiry';
                const emotionalState = analysis.emotionalCues || ['neutral'];
                const patterns = analysis.patterns || [];
                const currentLevel = this.calculateCurrentLevel(analysis.topics);
                
                // Adaptive response style based on comprehensive analysis
                let responseStyle = this.determineResponseStyle(complexity, learningIntent, emotionalState[0]);
                let responseDepth = this.calculateResponseDepth(currentLevel, complexity);
                
                // Check for context from recent problems for intelligent continuity
                const recentContext = this.contextMemory.recentProblems.length > 0 ? 
                    this.contextMemory.recentProblems.slice(-1)[0] : null;
                
                let contextualPrefix = '';
                if (recentContext && analysis.topics.some(topic => recentContext.topics.includes(topic))) {
                    contextualPrefix = `Continuing our ${recentContext.topics[0]} exploration: `;
                }
                
                // Emotional intelligence in responses
                let emotionalResponse = this.getEmotionallyAwarePrefix(emotionalState[0]);
                
                // Enhanced problem-specific responses with deep AI thinking
                if (input.includes("2x + 5 = 15")) {
                    this.recordUserSuccess('algebra', 'linear_equations');
                    const thinkingProcess = this.generateMathematicalThinking('linear_equation', complexity);
                    return demoPrefix + emotionalResponse + contextualPrefix + 
                        `Let me think through this linear equation systematically:\n\n` +
                        `**My Mathematical Thinking:**\n${thinkingProcess}\n\n` +
                        `**Solution Process:**\n` +
                        `**Step 1:** Isolate the term with x by subtracting 5 from both sides\n` +
                        `2x + 5 - 5 = 15 - 5\n` +
                        `2x = 10\n\n` +
                        `**Step 2:** Solve for x by dividing both sides by the coefficient 2\n` +
                        `2x ÷ 2 = 10 ÷ 2\n` +
                        `x = 5\n\n` +
                        `**Verification:** Let me check: 2(5) + 5 = 10 + 5 = 15 ✓\n\n` +
                        `${this.generateLearningInsight('algebra', complexity, learningIntent)}\n\n` +
                        `${this.getPersonalizedFollowUp('algebra', currentLevel)}`;
                        
                } else if (input.includes("derivative") && input.includes("x²")) {
                    this.recordUserSuccess('calculus', 'power_rule');
                    const thinkingProcess = this.generateMathematicalThinking('derivative', complexity);
                    return demoPrefix + emotionalResponse + contextualPrefix + 
                        `Let me work through this derivative using calculus principles:\n\n` +
                        `**My Mathematical Reasoning:**\n${thinkingProcess}\n\n` +
                        `**Derivative Calculation:**\n` +
                        `Given: f(x) = x² + 3x - 2\n\n` +
                        `**Step 1:** Apply the power rule: d/dx[xⁿ] = n·xⁿ⁻¹\n` +
                        `d/dx[x²] = 2·x²⁻¹ = 2x\n\n` +
                        `**Step 2:** Apply the constant multiple rule: d/dx[cx] = c\n` +
                        `d/dx[3x] = 3\n\n` +
                        `**Step 3:** The derivative of a constant is zero\n` +
                        `d/dx[-2] = 0\n\n` +
                        `**Final Answer:** f'(x) = 2x + 3\n\n` +
                        `${this.generateLearningInsight('calculus', complexity, learningIntent)}\n\n` +
                        `${this.getPersonalizedFollowUp('calculus', currentLevel)}`;
                        
                } else if (input.includes("area") && input.includes("circle")) {
                    this.recordUserSuccess('geometry', 'circle_area');
                    const thinkingProcess = this.generateMathematicalThinking('circle_area', complexity);
                    return demoPrefix + emotionalResponse + contextualPrefix + 
                        `Let me approach this circle area problem methodically:\n\n` +
                        `**My Geometric Reasoning:**\n${thinkingProcess}\n\n` +
                        `**Area Calculation:**\n` +
                        `**Formula:** A = πr² (where r is the radius)\n` +
                        `**Given:** radius = 5 units\n\n` +
                        `**Calculation:**\n` +
                        `A = π × (5)²\n` +
                        `A = π × 25\n` +
                        `A = 25π square units\n\n` +
                        `**Numerical approximation:** 25π ≈ 25 × 3.14159 ≈ 78.54 square units\n\n` +
                        `${this.generateLearningInsight('geometry', complexity, learningIntent)}\n\n` +
                        `${this.getPersonalizedFollowUp('geometry', currentLevel)}`;
                        
                } else if (input.includes("quadratic formula")) {
                    const thinkingProcess = this.generateMathematicalThinking('quadratic_formula', complexity);
                    return demoPrefix + emotionalResponse + contextualPrefix + 
                        `The quadratic formula is a powerful tool - let me explain my thinking:\n\n` +
                        `**My Mathematical Analysis:**\n${thinkingProcess}\n\n` +
                        `**The Quadratic Formula:**\n` +
                        `For equations of the form ax² + bx + c = 0:\n\n` +
                        `**x = (-b ± √(b² - 4ac)) / (2a)**\n\n` +
                        `**Deep Understanding:**\n` +
                        `• **Discriminant (b² - 4ac)**: Tells us about solution types\n` +
                        `  - Positive: Two real solutions\n` +
                        `  - Zero: One real solution (repeated root)\n` +
                        `  - Negative: Two complex solutions\n` +
                        `• **±**: Accounts for both intersection points with x-axis\n` +
                        `• **2a**: Relates to the parabola's "width"\n\n` +
                        `${this.generateLearningInsight('algebra', complexity, learningIntent)}\n\n` +
                        `${this.getPersonalizedFollowUp('algebra', currentLevel)}`;
                        
                } else if (input.includes("factor") && input.includes("x² - 9")) {
                    this.recordUserSuccess('algebra', 'factoring');
                    const thinkingProcess = this.generateMathematicalThinking('factoring', complexity);
                    return demoPrefix + emotionalResponse + contextualPrefix + 
                        `Excellent! I recognize this as a special pattern. Let me show my thinking:\n\n` +
                        `**My Pattern Recognition:**\n${thinkingProcess}\n\n` +
                        `**Factoring Process:**\n` +
                        `**Pattern Recognition:** x² - 9 is a difference of squares\n` +
                        `**General Form:** a² - b² = (a + b)(a - b)\n\n` +
                        `**Step 1:** Identify the squares\n` +
                        `x² - 9 = x² - 3² = (x)² - (3)²\n\n` +
                        `**Step 2:** Apply the difference of squares pattern\n` +
                        `(x)² - (3)² = (x + 3)(x - 3)\n\n` +
                        `**Verification:** (x + 3)(x - 3) = x² - 3x + 3x - 9 = x² - 9 ✓\n\n` +
                        `${this.generateLearningInsight('algebra', complexity, learningIntent)}\n\n` +
                        `${this.getPersonalizedFollowUp('algebra', currentLevel)}`;
                        
                } else if (input.includes("help") || input.includes("how")) {
                    const suggestions = this.generatePersonalizedSuggestions();
                    const learningProfile = this.generateLearningProfileSummary();
                    return demoPrefix + emotionalResponse + 
                        `I'm your advanced AI math tutor with sophisticated reasoning capabilities! Here's what I can do for you:\n\n` +
                        `🧠 **My AI Thinking Process:**\n` +
                        `• Deep mathematical pattern recognition\n` +
                        `• Emotional intelligence and adaptation\n` +
                        `• Learning style analysis and optimization\n` +
                        `• Context-aware problem solving\n` +
                        `• Prerequisite knowledge assessment\n\n` +
                        `📊 **Your Learning Profile:**\n${learningProfile}\n\n` +
                        `🎯 **Intelligent Recommendations:**\n` +
                        `${suggestions.map(s => '• ' + s).join('\n')}\n\n` +
                        `💡 **Enhanced Features:**\n` +
                        `• Complexity-adaptive explanations\n` +
                        `• Multi-layered problem analysis\n` +
                        `• Continuous learning optimization\n` +
                        `• Emotional state awareness\n\n` +
                        `What mathematical challenge would you like to tackle together?`;
                        
                } else {
                    // For unknown queries, provide sophisticated AI analysis
                    const sophisticatedAnalysis = this.generateSophisticatedAnalysis(userInput, analysis);
                    const suggestions = this.generatePersonalizedSuggestions();
                    
                    return demoPrefix + emotionalResponse + 
                        `Interesting mathematical inquiry! Let me analyze this with my advanced AI capabilities:\n\n` +
                        `**My Analysis:**\n${sophisticatedAnalysis}\n\n` +
                        `**What I've Learned About Your Learning:**\n` +
                        `• Current focus: ${this.contextMemory.currentTopic || 'Exploring your interests'}\n` +
                        `• Complexity level: ${complexity} (${this.conversationHistory.length} interactions analyzed)\n` +
                        `• Learning intent: ${learningIntent}\n` +
                        `• Emotional state: ${emotionalState.join(', ')}\n\n` +
                        `**Intelligent Suggestions:**\n` +
                        `${suggestions.slice(0, 3).map(s => '• ' + s).join('\n')}\n\n` +
                        `**Unlock Full AI Power:**\n` +
                        `Configure your OpenAI API key for unlimited, context-aware tutoring with even more sophisticated reasoning!\n\n` +
                        `Or try asking about specific math topics - I'm ready to think through any problem with you!`;
                }
            }

            determineResponseStyle(complexity, learningIntent, emotionalState) {
                let style = 'balanced';
                
                if (complexity === 'basic' || emotionalState === 'confused') {
                    style = 'simplified';
                } else if (complexity === 'expert' && learningIntent === 'understand_concept') {
                    style = 'comprehensive';
                } else if (emotionalState === 'frustrated') {
                    style = 'supportive';
                } else if (emotionalState === 'excited' || emotionalState === 'curious') {
                    style = 'engaging';
                }
                
                return style;
            }

            calculateResponseDepth(currentLevel, complexity) {
                const levelScores = { 'beginner': 1, 'intermediate': 2, 'advanced': 3, 'expert': 4 };
                const complexityScores = { 'basic': 1, 'intermediate': 2, 'advanced': 3, 'expert': 4 };
                
                const average = (levelScores[currentLevel] + complexityScores[complexity]) / 2;
                
                if (average <= 1.5) return 'surface';
                if (average <= 2.5) return 'moderate';
                if (average <= 3.5) return 'deep';
                return 'profound';
            }

            getEmotionallyAwarePrefix(emotionalState) {
                const prefixes = {
                    'confused': 'I understand this can be confusing - let\'s break it down clearly. ',
                    'frustrated': 'I can sense this is challenging - let\'s tackle it step by step. ',
                    'curious': 'I love your curiosity! Let me explore this with you. ',
                    'excited': 'Your enthusiasm is great! Let\'s dive into this together. ',
                    'anxious': 'Let\'s work through this calmly and methodically. ',
                    'confident': 'Great confidence! Let me build on what you know. ',
                    'neutral': ''
                };
                
                return prefixes[emotionalState] || '';
            }

            generateMathematicalThinking(problemType, complexity) {
                const thinking = {
                    'linear_equation': {
                        'basic': 'I need to isolate x by undoing the operations step by step.',
                        'intermediate': 'This is a linear equation - I can use inverse operations to solve systematically.',
                        'advanced': 'Linear equations represent straight lines; solving finds where the line crosses the x-axis.',
                        'expert': 'This represents a linear transformation; I\'ll use algebraic principles to find the inverse mapping.'
                    },
                    'derivative': {
                        'basic': 'Derivatives tell us the rate of change, like slope at any point.',
                        'intermediate': 'I\'ll apply differentiation rules to find how the function changes.',
                        'advanced': 'This requires understanding limits and instantaneous rate of change concepts.',
                        'expert': 'I\'m computing the linear approximation operator using calculus fundamentals.'
                    },
                    'circle_area': {
                        'basic': 'The area formula πr² comes from adding up all the tiny pieces inside the circle.',
                        'intermediate': 'This formula derives from integration of the circle\'s equation.',
                        'advanced': 'The area represents the integral of the circle\'s radius function over the angular domain.',
                        'expert': 'This involves the geometric measure of a 2D manifold in Euclidean space.'
                    }
                };
                
                return thinking[problemType] && thinking[problemType][complexity] || 
                       'I\'m analyzing the mathematical structure and relationships in this problem.';
            }

            generateLearningInsight(topic, complexity, learningIntent) {
                const insights = {
                    'algebra': 'Algebra is about finding unknowns using logical steps - like detective work with numbers!',
                    'calculus': 'Calculus reveals the hidden patterns of change in our world - from physics to economics.',
                    'geometry': 'Geometry connects abstract math to the physical world around us.'
                };
                
                const intentInsights = {
                    'understand_concept': 'Focus on the "why" - understanding principles makes everything else easier.',
                    'solve_problem': 'Each step builds on the last - mathematics is beautifully logical.',
                    'learn_method': 'Master the technique, then you can tackle similar problems confidently.'
                };
                
                return `💡 **Learning Insight:** ${insights[topic] || 'Mathematics is all about patterns and relationships!'} ${intentInsights[learningIntent] || ''}`;
            }

            generateLearningProfileSummary() {
                const interactions = this.conversationHistory.length;
                const strengths = this.contextMemory.userStrengths.slice(0, 3);
                const currentLevel = this.calculateCurrentLevel(Object.keys(this.learningAnalytics.topicFrequency));
                
                return `• Learning Level: ${currentLevel} (based on ${interactions} interactions)\n` +
                       `• Preferred Style: ${this.userProfile.learningStyle}\n` +
                       `• Strong Areas: ${strengths.join(', ') || 'Building your profile...'}\n` +
                       `• Response Style: ${this.userProfile.responsePreferences.detailLevel} detail, ${this.userProfile.responsePreferences.stepByStep ? 'step-by-step' : 'conceptual'}`;
            }

            generateSophisticatedAnalysis(userInput, analysis) {
                const topicAnalysis = analysis.topics.length > 0 ? 
                    `I detect ${analysis.topics.join(' and ')} concepts in your question.` : 
                    'I\'m analyzing the mathematical domain of your inquiry.';
                    
                const complexityAnalysis = `The complexity level appears to be ${analysis.complexity}.`;
                const intentAnalysis = `Your learning intent seems to be: ${analysis.learningIntent.replace('_', ' ')}.`;
                const patternAnalysis = analysis.patterns && analysis.patterns.length > 0 ? 
                    `I notice these mathematical patterns: ${analysis.patterns.join(', ')}.` : 
                    'I\'m identifying underlying mathematical patterns.';
                
                return `${topicAnalysis} ${complexityAnalysis} ${intentAnalysis} ${patternAnalysis}`;
            }

            getPersonalizedFollowUp(topic) {
                const followUps = {
                    'algebra': [
                        'Would you like to try a similar problem?',
                        'Shall we explore more advanced algebra concepts?',
                        'Ready for a quadratic equation next?'
                    ],
                    'calculus': [
                        'Want to practice more derivatives?',
                        'Should we move on to integration?',
                        'Ready for chain rule applications?'
                    ],
                    'geometry': [
                        'Would you like to explore 3D shapes?',
                        'Shall we work on geometric proofs?',
                        'Ready for trigonometry connections?'
                    ]
                };
                
                const topicFollowUps = followUps[topic] || ['What would you like to explore next?'];
                const randomFollowUp = topicFollowUps[Math.floor(Math.random() * topicFollowUps.length)];
                
                return `💡 **Next Step:** ${randomFollowUp}`;
            }

            getUserFocusAreas(topic) {
                const frequency = this.learningAnalytics.topicFrequency[topic] || 0;
                if (frequency > 0) {
                    return `• You've practiced ${topic} ${frequency} times - great consistency!`;
                }
                return '• New topic for you - I\'ll start with fundamentals!';
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                }, 100);
            }

            clearChat() {
                // Remove all messages and sample problems
                this.chatContainer.innerHTML = '';
                
                // Remove typing indicator if present
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                // Reset state
                this.isTyping = false;
                this.sendBtn.disabled = false;
                this.chatInput.disabled = false;
                this.chatInput.value = '';
                
                // Reinitialize chat with welcome message and sample problems
                this.initializeChat();
                
                this.showToast('💬 Chat cleared! Ready for new questions.');
            }

            showToast(message) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }

            // Speech Recognition Methods
            initializeSpeechRecognition() {
                // Check if browser supports speech recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        this.updateVoiceButton();
                        this.showToast('🎤 Listening... Speak now!');
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.chatInput.value = transcript;
                        this.showToast('✅ Speech captured! Click send or press Enter.');
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showToast('❌ Speech recognition error. Please try again.');
                        this.isRecording = false;
                        this.updateVoiceButton();
                    };
                    
                    this.recognition.onend = () => {
                        this.isRecording = false;
                        this.updateVoiceButton();
                    };
                } else {
                    console.warn('Speech recognition not supported in this browser');
                }
            }

            toggleVoiceRecording() {
                if (!this.recognition) {
                    this.showToast('❌ Speech recognition not supported in this browser');
                    return;
                }

                if (this.isRecording) {
                    this.recognition.stop();
                    this.showToast('🛑 Recording stopped');
                } else {
                    // Check for microphone permission
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(() => {
                            this.recognition.start();
                        })
                        .catch((error) => {
                            console.error('Microphone permission denied:', error);
                            this.showToast('❌ Microphone permission required for voice input');
                        });
                }
            }

            updateVoiceButton() {
                if (this.isRecording) {
                    this.voiceBtn.classList.add('animate-pulse');
                    this.voiceBtn.classList.add('bg-red-500/20');
                    this.voiceBtn.classList.add('border-red-400/40');
                    this.voiceBtn.classList.remove('border-amber-500/20');
                    this.voiceBtn.innerHTML = `
                        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="6" y="6" width="12" height="12" rx="2" stroke-width="2"></rect>
                        </svg>
                    `;
                } else {
                    this.voiceBtn.classList.remove('animate-pulse');
                    this.voiceBtn.classList.remove('bg-red-500/20');
                    this.voiceBtn.classList.remove('border-red-400/40');
                    this.voiceBtn.classList.add('border-amber-500/20');
                    this.voiceBtn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    `;
                }
            }

            // File Upload Methods
            handleFileUpload() {
                // Create hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*,text/*,.pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif';
                fileInput.multiple = false;
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        this.processUploadedFile(file);
                    }
                };
                
                fileInput.click();
            }

            processUploadedFile(file) {
                const maxSize = 5 * 1024 * 1024; // 5MB limit
                
                if (file.size > maxSize) {
                    this.showToast('❌ File too large. Please select a file smaller than 5MB.');
                    return;
                }

                this.showToast('📁 Processing file...');
                
                if (file.type.startsWith('image/')) {
                    this.handleImageUpload(file);
                } else if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                    this.handleTextFileUpload(file);
                } else {
                    // For other file types, just acknowledge the upload
                    this.showToast(`📄 ${file.name} uploaded successfully! Describe your question about this file.`);
                    this.chatInput.value = `I uploaded a file: ${file.name}. `;
                    this.chatInput.focus();
                }
            }

            handleImageUpload(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    
                    // Create a message with the uploaded image
                    this.addImageMessage(file.name, imageData);
                    this.showToast('🖼️ Image uploaded! Ask me about the math problem in the image.');
                    
                    // Auto-suggest some questions
                    this.chatInput.value = 'Can you help me solve the math problem shown in this image?';
                    this.chatInput.focus();
                };
                reader.readAsDataURL(file);
            }

            handleTextFileUpload(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const textContent = e.target.result;
                    
                    // Limit text length for display
                    const preview = textContent.length > 500 ? 
                        textContent.substring(0, 500) + '...' : textContent;
                    
                    this.addTextFileMessage(file.name, preview);
                    this.showToast('📝 Text file uploaded! Ask me about the math content.');
                    
                    this.chatInput.value = `Can you help me with the math problems in the uploaded file: ${file.name}?`;
                    this.chatInput.focus();
                };
                reader.readAsText(file);
            }

            addImageMessage(fileName, imageData) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex gap-4 justify-end message-fade-in';
                
                const timestamp = new Date().toLocaleTimeString();
                
                messageDiv.innerHTML = `
                    <div class="relative max-w-2xl p-5 bg-emerald-500/10 backdrop-blur-xl border border-emerald-500/30 rounded-2xl ml-auto">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/8 to-emerald-400/5 rounded-2xl"></div>
                        <div class="relative">
                            <div class="mb-3">
                                <img src="${imageData}" alt="Uploaded image" class="max-w-full h-auto rounded-lg border border-emerald-500/20" style="max-height: 300px;">
                            </div>
                            <p class="text-emerald-100 text-sm">📁 Uploaded: ${fileName}</p>
                            <div class="flex items-center justify-end mt-3 pt-3 border-t border-slate-700/30">
                                <span class="text-xs text-slate-500">${timestamp}</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-10 h-10 flex-shrink-0 mt-1 border border-amber-400/30 rounded-full bg-slate-800 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                `;

                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            addTextFileMessage(fileName, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex gap-4 justify-end message-fade-in';
                
                const timestamp = new Date().toLocaleTimeString();
                
                messageDiv.innerHTML = `
                    <div class="relative max-w-2xl p-5 bg-emerald-500/10 backdrop-blur-xl border border-emerald-500/30 rounded-2xl ml-auto">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/8 to-emerald-400/5 rounded-2xl"></div>
                        <div class="relative">
                            <p class="text-emerald-100 text-sm mb-2">📄 Uploaded: ${fileName}</p>
                            <div class="bg-slate-700/30 rounded-lg p-3 mb-3 max-h-32 overflow-y-auto">
                                <pre class="text-slate-300 text-xs whitespace-pre-wrap">${content}</pre>
                            </div>
                            <div class="flex items-center justify-end mt-3 pt-3 border-t border-slate-700/30">
                                <span class="text-xs text-slate-500">${timestamp}</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-10 h-10 flex-shrink-0 mt-1 border border-amber-400/30 rounded-full bg-slate-800 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                `;

                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
        }

        // Initialize the chat when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            new MathTutorChat();
            
            // Add button click effects
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    e.target.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        e.target.style.transform = 'scale(1)';
                    }, 100);
                }
            });

            // Add input focus effects
            document.getElementById('chatInput').addEventListener('focus', function() {
                this.parentElement.style.borderColor = 'rgba(34, 197, 94, 0.6)';
            });

            document.getElementById('chatInput').addEventListener('blur', function() {
                this.parentElement.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            });
        });
    </script>
</body>
</html>
